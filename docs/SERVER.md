# Server configuration

## Components

### NGINX
- отдает (закэшированные) статические XML файлы (VAST) ~23k запросов/сек
- получает события показов ~3k запросов/сек
- пишет в лог события обращений за XML и события показов (25k запросов/сек * 300b = ~8 Мб/с)
- отдает статику фронтенда
- проксирует вызовы API бэкенда

### Tmpfs
- содержит лог-файл NGINX, размер обычно не превышает 600 Мб (см. ротацию); максимальный доступный объем 1 Гб

### Crontab
- ротирует лог-файл NGINX каждую минуту, ротированный файл удаляется

### Vector
- отправляет строки событий из лог-файла в Clickhouse
    - периодичность запуска 1 сек
    - буферизация: 100k строк (https://vector.dev/docs/reference/sinks/clickhouse/#buffer) (100k * 300b = 30 Мб)
    - пакетирование: 25k строк (https://vector.dev/docs/reference/sinks/clickhouse/#batch)

### Clickhouse
- принимает пакетированные запросы на загрузку строк лог-файла во входную таблицу (1 запрос/сек)
    - [Здесь](https://clickhouse.tech/docs/en/single/#performance) рекомендуют не более 1 запроса/сек на вставку (см. пакетирование в Vector)
- строит материализованные представления по конкретным типам событий путем парсинга `path` из лог файла
    - также используются `timestamp` и `referer`
- [Q] агрегирование?    
- обрабатывает запросы на получение статистики из материализованных представлений

### PostgreSQL
- хранит данные бизнес-логики (настройки фильтрации, блоклисты и т.п.)

### JVM
- исполнение кода бэкенда